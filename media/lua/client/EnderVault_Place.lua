--[[██████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████
   ░▒▓█████▓▒░     ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓███████▓▒░   ░▒▓██████▓▒░   ░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓███████▓▒░    ░▒▓███████▓▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░     ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓█▓▒░ ░▒▓█▓▒░  ▒▓░    ░▒▓█▓▒░   ░▒▓█▒░  ░▒▓█▒░
  ░▒▓█▓▒░          ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░     ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█▓▒░ ░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▒░  ░▒▓█▒░
  ░▒▓█▓▒▒▓███▓▒░   ░▒▓█▓▒░         ░▒▓██████▓▒░      ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█████████▓▒░     ░▒▓███▓▒░     ░▒▓███████▓▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░           ░▒▓█▓▒░         ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█▓▒░ ░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▓▒░  ░▒▓▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░           ░▒▓█▓▒░         ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓█▓▒░ ░▒▓█▓▒░  ▒▓░    ░▒▓█▓▒░   ░▒▓█▓▒░  ░▒█▒░
   ░▒▓██████▓▒░    ░▒▓████████▓▒░    ░▒▓█▓▒░         ░▒▓█▓▒░      ░▒▓██████▓▒░   ░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓███████▓▒░    ░▒▓█▓▒░  ░▒█▒░
|‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾|
|                        				 Custom  PZ  Mod  Developer  for  Hire													  |
|‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾|
|                       	Portfolio:  https://steamcommunity.com/id/glytch3r/myworkshopfiles/							          |
|                       		                                    														 	  |
|                       	Discord:    Glytch3r#1337 / glytch3r															      |
|                       		                                    														 	  |
|                       	Support:    https://ko-fi.com/glytch3r														    	  |
|_______________________________________________________________________________________________________________________________-]]
--[[_____________________________________________________________________________________________________________________________
   ░▒▓██████▓▒░    ░▒▓████████▓▒░    ░▒▓█▓▒░         ░▒▓█▓▒░      ░▒▓██████▓▒░   ░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓███████▓▒░    ░▒▓█▓▒░  ░▒█▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░           ░▒▓█▓▒░         ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓█▓▒░ ░▒▓█▓▒░  ▒▓░    ░▒▓█▓▒░   ░▒▓█▓▒░  ░▒█▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░           ░▒▓█▓▒░         ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█▓▒░ ░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▓▒░  ░▒▓▒░
  ░▒▓█▓▒▒▓███▓▒░   ░▒▓█▓▒░         ░▒▓██████▓▒░      ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█████████▓▒░     ░▒▓███▓▒░     ░▒▓███████▓▒░
  ░▒▓█▓▒░          ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░     ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█▓▒░ ░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▒░  ░▒▓█▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░     ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓█▓▒░ ░▒▓█▓▒░  ▒▓░    ░▒▓█▓▒░   ░▒▓█▒░  ░▒▓█▒░
   ░▒▓█████▓▒░     ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓███████▓▒░   ░▒▓██████▓▒░   ░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓███████▓▒░    ░▒▓███████▓▒░
█████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████--]]

EnderVault = EnderVault or {}

function EnderVault.getPointer()
    local pl = getPlayer()
    if not pl then return nil end
    local zPos = pl:getZ()
    local xx, yy = ISCoordConversion.ToWorld(getMouseXScaled(), getMouseYScaled(), zPos)
    return getCell():getGridSquare(math.floor(xx), math.floor(yy), zPos)
end


function EnderVault.loadCursor()
    ISEnderVaultTileCursor = ISBuildingObject:derive("ISEnderVaultTileCursor")

    function ISEnderVaultTileCursor:setDragNilAfterPlace(nilAfter)
        self.dragNilAfterPlace = nilAfter
    end
    function ISEnderVaultTileCursor:create(x, y, z, sq)
        local pl = getPlayer()
        --self.point = getCell():getGridSquare(x, y, z)
        local err = false
        local square = getCell():getGridSquare(x, y, z) or sq
        if not EnderVault.checkDist(pl, square) then
            pl:setHaloNote("Need to get closer", 150, 250, 150, 900)
            err = true
        end


        if not (square or square:isFree(false)) and EnderVault.isNothingThere(square) then
            pl:setHaloNote("Cannot place there", 150, 250, 150, 900)
            err = true
        end
        EnderVault.tempMark(square)
        if err then
            getCell():setDrag(nil, 0)
            ISMoveableCursor.clearCacheForAllPlayers();
            return
        end

        local props = ISMoveableSpriteProps.new(IsoObject.new(square, self.spr):getSprite())
        props.rawWeight = 10
        props:placeMoveableInternal(square, InventoryItemFactory.CreateItem("Base.Plank"), self.spr)
        getCell():setDrag(nil, 0)

        if not err then
            if self.vaultItem then


                ISMoveableCursor.clearCacheForAllPlayers();
                getCell():setDrag(nil, 0)
                EnderVault.delVaultItem(self.vaultItem)

            end
        end

    end


    function ISEnderVaultTileCursor:render(x, y, z, square)
        getPlayer():setHaloNote(tostring(self.spr), 150, 250, 150, 900)
        --self.square = square
        ISBuildingObject.render(self, x, y, z, square)
    end

    function ISEnderVaultTileCursor:new(main, alt, character, square, vaultItem)
        local o = setmetatable({}, self)
        self.__index = self
        o:init()
        o:setSprite(main)
        o:setNorthSprite(alt)
        o.main = main
        o.alt = alt
        o.vaultItem = vaultItem
        o.spr = main
        o.spr2 = alt
        o.sq = square
        o.square = square
        o.character = character
        o.player = 0
        o.rotate = false
        o.isTileCursor = true
        o.spriteName = main
        o.noNeedHammer = true
        o.skipBuildAction = false
        o.skipWalk2 = false
        o.canBeAlwaysPlaced = true
        return o
    end
    function ISEnderVaultTileCursor:rotateKey(key)
        if key == getCore():getKey("Rotate building") then


            --getCell():setDrag(nil, 0)
            if self.spr == self.main then
                self.spr = self.alt
                self:setSprite(self.alt)
                self:setNorthSprite(self.alt)
                self.spriteName = self.alt
            else
                self.spr = self.main
                self:setSprite(self.main)
                self:setNorthSprite(self.main)
                self.spriteName = self.main
            end


        end
    end

end

function EnderVault.delvaultItem(item)
    local pl = getPlayer()
    local plNum = pl:getPlayerNum()
    ISRemoveItemTool.removeItem(item, plNum)
end

function EnderVault.isNothingThere(square)
    local pl = getPlayer()
	if not square then return false end
	if square:isSolid() or square:isSolidTrans() then return false end
	if square:HasStairs() then return false end
	if square:HasTree() then return false end
	if not square:TreatAsSolidFloor() then return false end
    if buildUtil.stairIsBlockingPlacement( square, true ) then return false; end
	if square:isVehicleIntersecting() then return false end
	return true
end
Events.OnCreatePlayer.Add(function()
    EnderVault.loadCursor()
end)

--[[

   EnderVault.loadCursor()

]]





